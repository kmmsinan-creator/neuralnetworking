<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Correlation Heatmap</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.2.0/dist/chartjs-chart-matrix.min.js"></script>
  <style>
    body { background:#222; color:#fff; font-family:sans-serif; }
    canvas { max-width:800px; max-height:800px; }
  </style>
</head>
<body>
  <h2>Correlation Heatmap</h2>
  <canvas id="corrChart"></canvas>

  <script>
    const features = ["Survived","Pclass","Age","SibSp","Parch","Fare"];

    // --- Dummy Titanic-like data (replace with your real CSV parsing) ---
    const data = [
      {Survived:1,Pclass:3,Age:22,SibSp:1,Parch:0,Fare:7.25},
      {Survived:0,Pclass:1,Age:38,SibSp:1,Parch:0,Fare:71.28},
      {Survived:1,Pclass:3,Age:26,SibSp:0,Parch:0,Fare:7.92},
      {Survived:1,Pclass:1,Age:35,SibSp:1,Parch:0,Fare:53.1},
      {Survived:0,Pclass:3,Age:35,SibSp:0,Parch:0,Fare:8.05},
    ];

    function mean(arr){let n=0,sum=0;for(const v of arr){if(!isNaN(v)){sum+=v;n++;}}return sum/n;}
    function correlation(x,y){
      const n=Math.min(x.length,y.length);
      const mx=mean(x), my=mean(y);
      let num=0,dx=0,dy=0,count=0;
      for(let i=0;i<n;i++){
        if(isNaN(x[i])||isNaN(y[i])) continue;
        const a=x[i]-mx, b=y[i]-my;
        num+=a*b; dx+=a*a; dy+=b*b; count++;
      }
      return count?num/Math.sqrt(dx*dy):0;
    }

    // Build correlation dataset
    const corrMatrix=[];
    for(let i=0;i<features.length;i++){
      for(let j=0;j<features.length;j++){
        const xi=data.map(d=>+d[features[i]]);
        const yj=data.map(d=>+d[features[j]]);
        corrMatrix.push({x:j,y:i,v:correlation(xi,yj)});
      }
    }

    const ctx=document.getElementById("corrChart").getContext("2d");
    new Chart(ctx,{
      type:'matrix',
      data:{
        datasets:[{
          label:'Correlation',
          data:corrMatrix,
          backgroundColor(ctx){
            const v=ctx.dataset.data[ctx.dataIndex].v;
            const r=v<0?Math.round(-v*255):0;
            const b=v>0?Math.round(v*255):0;
            const g=255-Math.max(r,b);
            return `rgba(${r},${g},${b},0.9)`;
          },
          width:({chart})=>(chart.chartArea.width/features.length)-4,
          height:({chart})=>(chart.chartArea.height/features.length)-4,
        }]
      },
      options:{
        plugins:{
          tooltip:{callbacks:{label:ctx=>ctx.raw.v.toFixed(2)}},
          legend:{display:false},
          title:{display:true,text:'Correlation Heatmap',color:'#fff'}
        },
        scales:{
          x:{
            type:'linear',
            min:-0.5,
            max:features.length-0.5,
            ticks:{
              color:'#fff',
              callback:v=>features[v]
            },
            grid:{display:false}
          },
          y:{
            type:'linear',
            min:-0.5,
            max:features.length-0.5,
            ticks:{
              color:'#fff',
              callback:v=>features[v]
            },
            grid:{display:false}
          }
        }
      },
      plugins:[
        {
          id:'legendGradient',
          afterDraw(chart){
            const {ctx,chartArea:{left,right,bottom}}=chart;
            const barHeight=12;
            const barTop=bottom+25;
            const gradient=ctx.createLinearGradient(left,0,right,0);
            gradient.addColorStop(0,"rgb(255,0,0)");
            gradient.addColorStop(0.5,"rgb(255,255,255)");
            gradient.addColorStop(1,"rgb(0,0,255)");
            ctx.fillStyle=gradient;
            ctx.fillRect(left,barTop,right-left,barHeight);
            ctx.fillStyle="#fff";
            ctx.font="12px sans-serif";
            ctx.textAlign="left"; ctx.fillText("-1",left,barTop+barHeight+12);
            ctx.textAlign="center"; ctx.fillText("0",(left+right)/2,barTop+barHeight+12);
            ctx.textAlign="right"; ctx.fillText("+1",right,barTop+barHeight+12);
          }
        },
        {
          id:'matrixLabels',
          afterDatasetsDraw(chart){
            const {ctx}=chart;
            chart.data.datasets[0].data.forEach((d,i)=>{
              const meta=chart.getDatasetMeta(0);
              const pos=meta.data[i].getCenterPoint();
              ctx.save();
              const v=d.v;
              // adaptive text color
              const r=v<0?Math.round(-v*255):0;
              const b=v>0?Math.round(v*255):0;
              const g=255-Math.max(r,b);
              const luminance=(0.299*r+0.587*g+0.114*b)/255;
              ctx.fillStyle=luminance<0.5?"#fff":"#000";
              ctx.font="11px sans-serif";
              ctx.textAlign="center";
              ctx.textBaseline="middle";
              ctx.fillText(v.toFixed(2),pos.x,pos.y);
              ctx.restore();
            });
          }
        }
      ]
    });
  </script>
</body>
</html>
