<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Titanic EDA Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
    h1 { text-align: center; }
    .controls { text-align: center; margin: 20px; }
    select { padding: 5px; margin: 5px; }
    .chart { margin: 30px auto; max-width: 900px; }
  </style>
</head>
<body>
  <h1>Titanic EDA Dashboard</h1>

  <div class="controls">
    <label>Sex: 
      <select id="sexFilter">
        <option value="all">All</option>
        <option value="male">Male</option>
        <option value="female">Female</option>
      </select>
    </label>

    <label>Class: 
      <select id="classFilter">
        <option value="all">All</option>
        <option value="1">1st</option>
        <option value="2">2nd</option>
        <option value="3">3rd</option>
      </select>
    </label>
  </div>

  <div id="sex" class="chart"></div>
  <div id="pclass" class="chart"></div>
  <div id="agegroup" class="chart"></div>
  <div id="heatmap" class="chart"></div>

  <script>
    let rawData = [];

    // Helper to compute correlation between two arrays
    function correlation(x, y) {
      let n = x.length;
      let meanX = x.reduce((a,b)=>a+b,0)/n;
      let meanY = y.reduce((a,b)=>a+b,0)/n;
      let num = 0, denX = 0, denY = 0;
      for (let i=0; i<n; i++) {
        let dx = x[i]-meanX;
        let dy = y[i]-meanY;
        num += dx*dy;
        denX += dx*dx;
        denY += dy*dy;
      }
      return num / Math.sqrt(denX*denY);
    }

    function updateDashboard() {
      let sexFilter = document.getElementById('sexFilter').value;
      let classFilter = document.getElementById('classFilter').value;

      let data = rawData.filter(d => {
        if (sexFilter !== 'all' && d.Sex !== sexFilter) return false;
        if (classFilter !== 'all' && d.Pclass != classFilter) return false;
        return true;
      });

      // Helper: group survival rate
      function survivalRate(filterFn) {
        let subset = data.filter(filterFn);
        let survived = subset.filter(d => d.Survived === 1).length;
        return subset.length ? survived / subset.length : 0;
      }

      // Survival by Sex
      let sex_labels = ["Female", "Male"];
      let sex_values = [
        survivalRate(d => d.Sex === "female"),
        survivalRate(d => d.Sex === "male")
      ];

      Plotly.newPlot('sex', [{
        x: sex_labels,
        y: sex_values,
        type: 'bar',
        marker: {color: ['orange','steelblue']}
      }], {title: 'Survival Rate by Sex'});

      // Survival by Pclass
      let pclass_labels = ["1st","2nd","3rd"];
      let pclass_values = [
        survivalRate(d => d.Pclass === 1),
        survivalRate(d => d.Pclass === 2),
        survivalRate(d => d.Pclass === 3)
      ];

      Plotly.newPlot('pclass', [{
        x: pclass_labels,
        y: pclass_values,
        type: 'bar',
        marker: {color: 'green'}
      }], {title: 'Survival Rate by Passenger Class'});

      // Survival by Age Group
      function ageGroup(age) {
        if (!age) return null;
        if (age <= 12) return "Child";
        if (age <= 18) return "Teen";
        if (age <= 30) return "Young Adult";
        if (age <= 50) return "Adult";
        return "Senior";
      }

      let groups = ["Child","Teen","Young Adult","Adult","Senior"];
      let age_values = groups.map(g => survivalRate(d => ageGroup(d.Age) === g));

      Plotly.newPlot('agegroup', [{
        x: groups,
        y: age_values,
        type: 'bar',
        marker: {color: 'purple'}
      }], {title: 'Survival Rate by Age Group'});

      // Correlation Heatmap
      let features = ["Survived","Pclass","Age","SibSp","Parch","Fare"];
      let matrix = [];

      for (let i=0; i<features.length; i++) {
        let row = [];
        for (let j=0; j<features.length; j++) {
          let xi = data.map(d => parseFloat(d[features[i]])).filter(v => !isNaN(v));
          let yj = data.map(d => parseFloat(d[features[j]])).filter(v => !isNaN(v));
          let minLen = Math.min(xi.length, yj.length);
          xi = xi.slice(0,minLen);
          yj = yj.slice(0,minLen);
          row.push(correlation(xi,yj));
        }
        matrix.push(row);
      }

      Plotly.newPlot('heatmap', [{
        z: matrix,
        x: features,
        y: features,
        type: 'heatmap',
        colorscale: 'RdBu'
      }], {title: 'Correlation Heatmap'});
    }

    // Load CSV dynamically
    Papa.parse("train.csv", {
      download: true,
      header: true,
      dynamicTyping: true,
      complete: function(results) {
        rawData = results.data.filter(d => d.Survived !== undefined && d.Survived !== "");
        updateDashboard();
      }
    });

    // Add event listeners for filters
    document.getElementById('sexFilter').addEventListener('change', updateDashboard);
    document.getElementById('classFilter').addEventListener('change', updateDashboard);
  </script>
</body>
</html>
